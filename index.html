<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone</title>
    <link rel="icon" href="data:,"> 
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <!-- New Chat Button -->
            <div class="sidebar-header">
                <button id="newChatBtn" class="new-chat-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>ìƒˆ ì±„íŒ…</span>
                </button>
            </div>

            <!-- Conversations List -->
            <div id="conversationsList" class="conversations-list">
                <!-- ëŒ€í™” ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <!-- Bottom Menu -->
            <div class="sidebar-footer">
                <!-- ë¡œê·¸ì¸ ì•ˆë¨ ìƒíƒœ -->
                <div id="authButtons" class="auth-buttons">
                    <a href="login.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                        <span>ë¡œê·¸ì¸</span>
                    </a>
                    <a href="signup.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        <span>íšŒì›ê°€ì…</span>
                    </a>
                </div>

                <!-- ë¡œê·¸ì¸ë¨ ìƒíƒœ -->
                <div id="userMenu" class="user-menu hidden">
                    <button id="accountBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="userName">ë‚´ ê³„ì •</span>
                    </button>
                    <button id="settingsBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.196-13.804l-4.243 4.243m0 6.364l4.243 4.243M23 12h-6m-6 0H1m18.804-5.196l-4.243 4.243m0 6.364l4.243 4.243"></path>
                        </svg>
                        <span>ì„¤ì •</span>
                    </button>
                    <button id="logoutBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>ë¡œê·¸ì•„ì›ƒ</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <button id="toggleSidebarBtn" class="menu-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="chat-title">ChatGPT 4</h1>
            </header>
            <!-- Messages Area -->
            <div id="messagesContainer" class="messages-container">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-content">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h2 class="empty-title">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                        <div class="suggestions-grid">
                            <button class="suggestion-btn" data-suggestion="ì½”ë“œ ì‘ì„± ë„ì›€">ì½”ë“œ ì‘ì„± ë„ì›€</button>
                            <button class="suggestion-btn" data-suggestion="ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë°">ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë°</button>
                            <button class="suggestion-btn" data-suggestion="ì§ˆë¬¸ì— ë‹µë³€í•˜ê¸°">ì§ˆë¬¸ì— ë‹µë³€í•˜ê¸°</button>
                            <button class="suggestion-btn" data-suggestion="ê¸€ì“°ê¸° ë„ì›€">ê¸€ì“°ê¸° ë„ì›€</button>
                        </div>
                    </div>
                </div>
                <div id="messagesList" class="messages-list">
                    <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="send-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <p class="input-disclaimer">
                    ChatGPTëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” í™•ì¸í•˜ì„¸ìš”.
                </p>
            </div>
        </main>
    </div>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const userStr = localStorage.getItem('user');
    const authButtons = document.getElementById('authButtons');
    const userMenu = document.getElementById('userMenu');
    const userNameSpan = document.getElementById('userName');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesList = document.getElementById('messagesList');
    const conversationsList = document.getElementById('conversationsList'); // ì‚¬ì´ë“œë°” ëª©ë¡
    const emptyState = document.getElementById('emptyState');

    let currentUser = null;
    let currentConversationId = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” ëŒ€í™”ë°© ID

    // 1. ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    if (userStr) {
        currentUser = JSON.parse(userStr);
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        userNameSpan.textContent = currentUser.name;
        messageInput.disabled = false;
        
        // ë¡œê·¸ì¸í–ˆìœ¼ë©´ ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadConversations();
    } else {
        messageInput.disabled = true;
        messageInput.placeholder = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    }

    // 2. ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('user');
            window.location.reload();
        }
    });

    // 3. ìƒˆ ì±„íŒ… ë²„íŠ¼
    document.getElementById('newChatBtn').addEventListener('click', () => {
        currentConversationId = null;
        messagesList.innerHTML = ''; // í™”ë©´ ë¹„ìš°ê¸°
        emptyState.classList.remove('hidden');
        loadConversations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì„ íƒ íš¨ê³¼ ì œê±°ìš©)
    });

    // 4. ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadConversations() {
        if (!currentUser) return;
        const res = await fetch(`/api/conversations/${currentUser.id}`);
        const conversations = await res.json();
        
        conversationsList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        conversations.forEach(conv => {
            const div = document.createElement('div');
            div.className = 'conversation-item';
            div.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <div class="conversation-title">${conv.title}</div>
            `;
            // ëª©ë¡ í´ë¦­ ì‹œ í•´ë‹¹ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
            div.addEventListener('click', () => loadMessages(conv.id));
            conversationsList.appendChild(div);
        });
    }

    // 5. íŠ¹ì • ëŒ€í™” ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadMessages(conversationId) {
        currentConversationId = conversationId;
        emptyState.classList.add('hidden');
        messagesList.innerHTML = ''; // í™”ë©´ ì´ˆê¸°í™”

        const res = await fetch(`/api/conversations/${conversationId}/messages`);
        const messages = await res.json();

        messages.forEach(msg => appendMessage(msg.role, msg.content));
        
        // ì‚¬ì´ë“œë°” ì„ íƒ íš¨ê³¼ (ê°„ë‹¨íˆ)
        loadConversations().then(() => {
            // ì—¬ê¸°ì— ì„ íƒëœ í•­ëª© í•˜ì´ë¼ì´íŠ¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        });
    }

    // 6. ë©”ì‹œì§€ ì „ì†¡
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    messageInput.addEventListener('input', () => sendBtn.disabled = messageInput.value.trim() === '');

    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentUser) return;

        messageInput.value = '';
        emptyState.classList.add('hidden');
        appendMessage('user', text);

        try {
            const loadingId = appendMessage('assistant', '...'); // ë¡œë”© í‘œì‹œ
            
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    message: text,
                    conversationId: currentConversationId // í˜„ì¬ ë°© ID (ì—†ìœ¼ë©´ null)
                })
            });

            const data = await res.json();
            document.getElementById(loadingId).remove(); // ë¡œë”© ì‚­ì œ

            if (res.ok) {
                appendMessage('assistant', data.reply);
                
                // ì²˜ìŒ ëŒ€í™” ì‹œì‘í–ˆë‹¤ë©´(ë°©ì´ ìƒˆë¡œ ìƒê²¼ë‹¤ë©´) ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                if (!currentConversationId) {
                    currentConversationId = data.conversationId;
                    loadConversations();
                }
            } else {
                appendMessage('assistant', 'Error: ' + data.error);
            }
        } catch (e) {
            console.error(e);
        }
    }

    // í™”ë©´ì— ë©”ì‹œì§€ ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜
    function appendMessage(role, text) {
        const msgId = 'msg-' + Date.now();
        const isUser = role === 'user';
        const html = `
            <div class="message" id="${msgId}">
                <div class="message-avatar ${role}">
                    ${isUser ? 'U' : 'G'}
                </div>
                <div class="message-content">
                    <div class="message-role">${isUser ? 'ë‚˜' : 'ChatGPT'}</div>
                    <div class="message-text">${text}</div>
                </div>
            </div>
        `;
        messagesList.insertAdjacentHTML('beforeend', html);
        messagesList.scrollTop = messagesList.scrollHeight; // ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°
        return msgId;
    }
});
</script>
</html>