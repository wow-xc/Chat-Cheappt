<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone</title>
    <link rel="icon" href="data:,"> 
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <!-- New Chat Button -->
            <div class="sidebar-header">
                <button id="newChatBtn" class="new-chat-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>ìƒˆ ì±„íŒ…</span>
                </button>
            </div>

            <!-- Conversations List -->
            <div id="conversationsList" class="conversations-list">
                <!-- ëŒ€í™” ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <!-- Bottom Menu -->
            <div class="sidebar-footer">
                <!-- ë¡œê·¸ì¸ ì•ˆë¨ ìƒíƒœ -->
                <div id="authButtons" class="auth-buttons">
                    <a href="login.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                        <span>ë¡œê·¸ì¸</span>
                    </a>
                    <a href="signup.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        <span>íšŒì›ê°€ì…</span>
                    </a>
                </div>

                <!-- ë¡œê·¸ì¸ë¨ ìƒíƒœ -->
                <div id="userMenu" class="user-menu hidden">
                    <button id="accountBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="userName">ë‚´ ê³„ì •</span>
                    </button>
                    <button id="settingsBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.196-13.804l-4.243 4.243m0 6.364l4.243 4.243M23 12h-6m-6 0H1m18.804-5.196l-4.243 4.243m0 6.364l4.243 4.243"></path>
                        </svg>
                        <span>ì„¤ì •</span>
                    </button>
                    <button id="logoutBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>ë¡œê·¸ì•„ì›ƒ</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <button id="toggleSidebarBtn" class="menu-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                
                <div class="model-selector">
                    <button id="modelBtn" class="model-btn">
                        <span id="currentModelText">GPT-4</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="modelMenu" class="model-menu hidden">
                        <div class="model-option" data-value="gpt-4">
                            <div class="model-name">GPT-4</div>
                            <div class="model-desc">ê°€ì¥ ë˜‘ë˜‘í•¨, ë³µì¡í•œ ì‘ì—…ìš©</div>
                        </div>
                        <div class="model-option" data-value="gpt-4o">
                            <div class="model-name">GPT-4o</div>
                            <div class="model-desc">ìµœì‹  ëª¨ë¸, ë¹ ë¥´ê³  ë˜‘ë˜‘í•¨</div>
                        </div>
                        <div class="model-option" data-value="gpt-3.5-turbo">
                            <div class="model-name">GPT-3.5 Turbo</div>
                            <div class="model-desc">ì—„ì²­ ë¹ ë¦„, ê°„ë‹¨í•œ ëŒ€í™”ìš©</div>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Messages Area -->
            <div id="messagesContainer" class="messages-container">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-content">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h2 class="empty-title">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                    </div>
                </div>
                <div id="messagesList" class="messages-list">
                    <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        rows="1"
                    ></textarea>
                    <button id="sendBtn" class="send-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <p class="input-disclaimer">
                    ChatGPTëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” í™•ì¸í•˜ì„¸ìš”.
                </p>
            </div>
        </main>
    </div>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const userStr = localStorage.getItem('user');
    const authButtons = document.getElementById('authButtons');
    const userMenu = document.getElementById('userMenu');
    const userNameSpan = document.getElementById('userName');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesList = document.getElementById('messagesList');
    const conversationsList = document.getElementById('conversationsList'); // ì‚¬ì´ë“œë°” ëª©ë¡
    const emptyState = document.getElementById('emptyState');

    let currentUser = null;
    let currentConversationId = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” ëŒ€í™”ë°© ID

    const toggleBtn = document.getElementById('toggleSidebarBtn'); // ì™¼ìª½ ìƒë‹¨ ì•„ì´ì½˜ ë²„íŠ¼
    const sidebar = document.getElementById('sidebar');            // ì‚¬ì´ë“œë°” ìš”ì†Œ

    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed'); // í´ë˜ìŠ¤ë¥¼ ì¤¬ë‹¤ ëºì—ˆë‹¤ í•¨
        });
    }

    // 0.5 ëª¨ë¸ ì„ íƒ ê¸°ëŠ¥
    const modelBtn = document.getElementById('modelBtn');
    const modelMenu = document.getElementById('modelMenu');
    const currentModelText = document.getElementById('currentModelText');
    let currentModel = 'gpt-4'; // ê¸°ë³¸ê°’

    // ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
    modelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        modelMenu.classList.toggle('hidden');
    });

    // ëª¨ë¸ ì„ íƒí•˜ê¸°
    document.querySelectorAll('.model-option').forEach(option => {
        option.addEventListener('click', () => {
            currentModel = option.dataset.value; // ì„ íƒí•œ ëª¨ë¸ ê°’ ì €ì¥
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ (ì„¤ëª… ë¹¼ê³  ì´ë¦„ë§Œ)
            currentModelText.textContent = option.querySelector('.model-name').textContent;
            
            modelMenu.classList.add('hidden'); // ë©”ë‰´ ë‹«ê¸°
        });
    });

    // í™”ë©´ ì•„ë¬´ë°ë‚˜ í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener('click', () => {
        if (!modelMenu.classList.contains('hidden')) {
            modelMenu.classList.add('hidden');
        }
    });

    // 1. ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    if (userStr) {
        currentUser = JSON.parse(userStr);
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        userNameSpan.textContent = currentUser.name;
        messageInput.disabled = false;
        
        // ë¡œê·¸ì¸í–ˆìœ¼ë©´ ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadConversations();
    } else {
        messageInput.disabled = true;
        messageInput.placeholder = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    }

    // 2. ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('user');
            window.location.reload();
        }
    });

    // 3. ìƒˆ ì±„íŒ… ë²„íŠ¼
    document.getElementById('newChatBtn').addEventListener('click', () => {
        currentConversationId = null;
        messagesList.innerHTML = ''; // í™”ë©´ ë¹„ìš°ê¸°
        emptyState.classList.remove('hidden');
        loadConversations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì„ íƒ íš¨ê³¼ ì œê±°ìš©)
    });

    // 4. ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    // 4. ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ìˆ˜ì •ë¨: ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
    async function loadConversations() {
        if (!currentUser) return;
        const res = await fetch(`/api/conversations/${currentUser.id}`);
        const conversations = await res.json();
        
        conversationsList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        
        conversations.forEach(conv => {
            const div = document.createElement('div');
            div.className = 'conversation-item';
            
            // HTML êµ¬ì„±: ì œëª© + ì‚­ì œ ë²„íŠ¼(íœ´ì§€í†µ)
            div.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <div class="conversation-title">${conv.title}</div>
                <div class="conversation-actions">
                    <button class="conversation-action-btn delete-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `;

            // 1. ëª©ë¡ í´ë¦­ ì‹œ í•´ë‹¹ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
            div.addEventListener('click', () => loadMessages(conv.id));

            // 2. ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            const deleteBtn = div.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // ë¶€ëª¨ ìš”ì†Œ(ëª©ë¡) í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€ (ì¤‘ìš”!)
                
                if (confirm('ì •ë§ ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    try {
                        const res = await fetch(`/api/conversations/${conv.id}`, { method: 'DELETE' });
                        if (res.ok) {
                            // í˜„ì¬ ë³´ê³  ìˆëŠ” ë°©ì„ ì‚­ì œí–ˆë‹¤ë©´ í™”ë©´ ë¹„ìš°ê¸°
                            if (currentConversationId === conv.id) {
                                document.getElementById('newChatBtn').click();
                            }
                            loadConversations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        } else {
                            alert('ì‚­ì œ ì‹¤íŒ¨');
                        }
                    } catch (err) {
                        console.error(err);
                    }
                }
            });

            conversationsList.appendChild(div);
        });
    }

    // 5. íŠ¹ì • ëŒ€í™” ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadMessages(conversationId) {
        currentConversationId = conversationId;
        emptyState.classList.add('hidden');
        messagesList.innerHTML = ''; // í™”ë©´ ì´ˆê¸°í™”

        const res = await fetch(`/api/conversations/${conversationId}/messages`);
        const messages = await res.json();

        messages.forEach(msg => appendMessage(msg.role, msg.content));
        
        // ì‚¬ì´ë“œë°” ì„ íƒ íš¨ê³¼ (ê°„ë‹¨íˆ)
        loadConversations().then(() => {
            // ì—¬ê¸°ì— ì„ íƒëœ í•­ëª© í•˜ì´ë¼ì´íŠ¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        });
    }

    // 6. ë©”ì‹œì§€ ì „ì†¡
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    messageInput.addEventListener('input', () => sendBtn.disabled = messageInput.value.trim() === '');
    messageInput.addEventListener('input', function() {
        // 1. ì „ì†¡ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€
        sendBtn.disabled = this.value.trim() === '';
        
        // 2. ë†’ì´ ì¡°ì ˆ ë¡œì§
        this.style.height = 'auto'; // ë†’ì´ ì´ˆê¸°í™”
        this.style.height = (this.scrollHeight) + 'px'; // ë‚´ìš©ë§Œí¼ ëŠ˜ë¦¬ê¸°
        
        // 200px ë„˜ìœ¼ë©´ ìŠ¤í¬ë¡¤ ìƒê¸°ê²Œ
        if (this.scrollHeight > 200) {
            this.style.overflowY = "scroll";
        } else {
            this.style.overflowY = "hidden";
        }
    });
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentUser) return;

        messageInput.value = '';
        messageInput.style.height = 'auto'; // <--- ì´ ì¤„ì´ ì¤‘ìš”í•©ë‹ˆë‹¤! (ì „ì†¡ í›„ ì¤„ì–´ë“¤ê¸°)
        sendBtn.disabled = true;
        emptyState.classList.add('hidden');
        appendMessage('user', text);

        try {
            const loadingId = appendMessage('assistant', '...'); // ë¡œë”© í‘œì‹œ
            
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    message: text,
                    conversationId: currentConversationId, // í˜„ì¬ ë°© ID (ì—†ìœ¼ë©´ null)
                    model: currentModel
                })
            });

            const data = await res.json();
            document.getElementById(loadingId).remove(); // ë¡œë”© ì‚­ì œ

            if (res.ok) {
                appendMessage('assistant', data.reply);
                
                // ì²˜ìŒ ëŒ€í™” ì‹œì‘í–ˆë‹¤ë©´(ë°©ì´ ìƒˆë¡œ ìƒê²¼ë‹¤ë©´) ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                if (!currentConversationId) {
                    currentConversationId = data.conversationId;
                    loadConversations();
                }
            } else {
                appendMessage('assistant', 'Error: ' + data.error);
            }
        } catch (e) {
            console.error(e);
        }
    }

    // í™”ë©´ì— ë©”ì‹œì§€ ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜
    // í™”ë©´ì— ë©”ì‹œì§€ ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜ (ìˆ˜ì •ë¨: ID ì¤‘ë³µ ë°©ì§€)
    function appendMessage(role, text) {
        // [ìˆ˜ì •] Date.now() ë’¤ì— ëœë¤ ìˆ«ìë¥¼ ë¶™ì—¬ì„œ ì ˆëŒ€ ì•ˆ ê²¹ì¹˜ê²Œ í•¨
        const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        const isUser = role === 'user';
        const html = `
            <div class="message" id="${msgId}">
                <div class="message-avatar ${role}">
                    ${isUser ? `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    ` : `
                    <div class="logo-icon" style="font-size: 16px;">ğŸ’¬</div>
                    `}
                </div>
                <div class="message-content">
                    <div class="message-role">${isUser ? 'ë‚˜' : 'ChatGPT'}</div>
                    <div class="message-text">${text}</div>
                </div>
            </div>
        `;
        messagesList.insertAdjacentHTML('beforeend', html);
        messagesList.scrollTop = messagesList.scrollHeight;
        return msgId;
    }
});
</script>
</html>