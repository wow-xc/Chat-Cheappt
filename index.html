<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatCheappt</title>
    <link rel="icon" href="data:,"> 
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <!-- New Chat Button -->
            <div class="sidebar-header">
                <button id="galleryBtn" class="new-chat-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <span>ë¼ì´ë¸ŒëŸ¬ë¦¬</span>
                </button>

                <button id="newChatBtn" class="new-chat-btn" >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>ìƒˆ ì±„íŒ…</span>
                </button>
            </div>

            <!-- Conversations List -->
            <div id="conversationsList" class="conversations-list">
                <!-- ëŒ€í™” ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <!-- Bottom Menu -->
            <div class="sidebar-footer">
                <!-- ë¡œê·¸ì¸ ì•ˆë¨ ìƒíƒœ -->
                <div id="authButtons" class="auth-buttons">
                    <a href="login.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                        <span>ë¡œê·¸ì¸</span>
                    </a>
                    <a href="signup.html" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        <span>íšŒì›ê°€ì…</span>
                    </a>
                </div>

                <!-- ë¡œê·¸ì¸ë¨ ìƒíƒœ -->
                <div id="userMenu" class="user-menu hidden">
                    <button id="accountBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <span id="userName">ë‚´ ê³„ì •</span>
                    </button>
                    <button id="settingsBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.196-13.804l-4.243 4.243m0 6.364l4.243 4.243M23 12h-6m-6 0H1m18.804-5.196l-4.243 4.243m0 6.364l4.243 4.243"></path>
                        </svg>
                        <span>ì„¤ì •</span>
                    </button>
                    <button id="logoutBtn" class="sidebar-menu-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>ë¡œê·¸ì•„ì›ƒ</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <button id="toggleSidebarBtn" class="menu-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                
                <div class="model-selector">
                    <button id="modelBtn" class="model-btn">
                        <span id="currentModelText">GPT-4</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="modelMenu" class="model-menu hidden" style="max-height: 400px; overflow-y: auto;">
    
                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">ìµœì‹  (Next Gen)</div>
                        <div class="model-option" data-value="gpt-5.1">
                            <div class="model-name">GPT-5.1</div>
                            <div class="model-desc">2025 ìµœì‹  ëª¨ë¸ (ìµœê³  ì„±ëŠ¥)</div>
                        </div>
                        <div class="model-option" data-value="gpt-5">
                            <div class="model-name">GPT-5</div>
                            <div class="model-desc">ê°•ë ¥í•œ ì„±ëŠ¥ ë° ì¶”ë¡  ëŠ¥ë ¥</div>
                        </div>
                        <div class="model-option" data-value="gpt-5-mini">
                            <div class="model-name">GPT-5 Mini</div>
                            <div class="model-desc">GPT-5ì˜ ê²½ëŸ‰í™” ë²„ì „</div>
                        </div>

                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">ì˜´ë‹ˆ (Omni)</div>
                        <div class="model-option" data-value="gpt-4o">
                            <div class="model-name">GPT-4o</div>
                            <div class="model-desc">ê°€ì¥ ë˜‘ë˜‘í•˜ê³  ë¹ ë¦„ (ì¶”ì²œ)</div>
                        </div>
                        <div class="model-option" data-value="gpt-4o-mini">
                            <div class="model-name">GPT-4o Mini</div>
                            <div class="model-desc">ì†ë„ ë¹ ë¥´ê³  ë§¤ìš° ì €ë ´í•¨</div>
                        </div>

                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">ì¶”ë¡  (Reasoning)</div>
                        <div class="model-option" data-value="o1">
                            <div class="model-name">OpenAI o1</div>
                            <div class="model-desc">ë³µì¡í•œ ìˆ˜í•™/ì½”ë”©/ê³¼í•™ í•´ê²°</div>
                        </div>
                        <div class="model-option" data-value="o1-mini">
                            <div class="model-name">OpenAI o1-mini</div>
                            <div class="model-desc">ë¹ ë¥¸ ì¶”ë¡  ëª¨ë¸</div>
                        </div>

                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">ê¸°ì¡´ ëª¨ë¸ (Legacy)</div>
                        <div class="model-option" data-value="gpt-4-turbo">
                            <div class="model-name">GPT-4 Turbo</div>
                            <div class="model-desc">GPT-4 ì™„ì„±í˜•</div>
                        </div>
                        <div class="model-option" data-value="gpt-4">
                            <div class="model-name">GPT-4</div>
                            <div class="model-desc">ì˜¤ë¦¬ì§€ë„ GPT-4</div>
                        </div>
                        <div class="model-option" data-value="gpt-3.5-turbo">
                            <div class="model-name">GPT-3.5 Turbo</div>
                            <div class="model-desc">ë¹ ë¥´ê³  ê°€ë²¼ìš´ êµ¬ë²„ì „</div>
                        </div>
                        <div class="model-category" style="padding: 8px 12px 4px; font-size: 11px; color: #888; font-weight: bold; border-bottom: 1px solid #444;">ì´ë¯¸ì§€ (Image)</div>
                        <div class="model-option" data-value="dall-e-3">
                            <div class="model-name">DALL-E 3</div>
                            <div class="model-desc">ê³ í’ˆì§ˆ ì´ë¯¸ì§€ ìƒì„± (ê·¸ë¦¼ ê·¸ë ¤ì¤˜)</div>
                        </div>
                    </div>
                </div>
            </header>
            <!-- Messages Area -->
            <div id="messagesContainer" class="messages-container">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-content">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h2 class="empty-title">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
                    </div>
                </div>
                <div id="messagesList" class="messages-list">
                    <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <div class="input-container">
                <div id="imagePreviewContainer" class="image-preview-container hidden">
                    <div class="preview-wrapper">
                        <img id="imagePreview" src="" alt="Preview">
                        <button id="removeImageBtn" class="remove-image-btn">&times;</button>
                    </div>
                </div>

                <div class="input-wrapper">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <button id="attachBtn" class="attach-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                    </button>

                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        rows="1"
                    ></textarea>
                    
                    <button id="sendBtn" class="send-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <p class="input-disclaimer">
                    ChatCheaptëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” í™•ì¸í•˜ì„¸ìš”.
                </p>
            </div>
        </main>
    </div>
    <div id="galleryModal" class="modal hidden">
    <div class="modal-content" style="max-width: 900px; width: 90%; height: 85vh; display: flex; flex-direction: column; background: #212121;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <h3 style="font-size: 20px; font-weight: 600;">ğŸ¨ ë‚´ ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬</h3>
            <button id="closeGalleryBtn" style="background: none; border: none; color: white; cursor: pointer; font-size: 28px;">&times;</button>
        </div>
        <div id="galleryGrid" class="gallery-grid">
            </div>
    </div>
</div>
<div id="confirmModal" class="modal hidden">
    <div class="modal-content" style="max-width: 360px; height: auto; text-align: center; padding: 32px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—‘ï¸</div>
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: white;">ëŒ€í™” ì‚­ì œ</h3>
        <p style="font-size: 15px; color: #bbb; margin-bottom: 24px; line-height: 1.5;">
            ì •ë§ë¡œ ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            ì‚­ì œëœ ëŒ€í™”ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancelDeleteBtn" class="sidebar-menu-btn" style="width: 100%; justify-content: center; background: #333; border-radius: 8px;">ì·¨ì†Œ</button>
            <button id="confirmDeleteBtn" class="submit-btn" style="width: 100%; margin-top: 0; background: #ef4444; color: white; border: none; border-radius: 8px;">ì‚­ì œ</button>
        </div>
    </div>
</div>
<div id="imageDeleteModal" class="modal hidden">
    <div class="modal-content" style="max-width: 360px; height: auto; text-align: center; padding: 32px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ–¼ï¸</div>
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: white;">ì‚¬ì§„ ì‚­ì œ</h3>
        <p style="font-size: 15px; color: #bbb; margin-bottom: 24px; line-height: 1.5;">
            ì´ ì‚¬ì§„ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            ì‚­ì œëœ íŒŒì¼ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancelImgDeleteBtn" class="sidebar-menu-btn" style="width: 100%; justify-content: center; background: #333; border-radius: 8px;">ì·¨ì†Œ</button>
            <button id="confirmImgDeleteBtn" class="submit-btn" style="width: 100%; margin-top: 0; background: #ef4444; color: white; border: none; border-radius: 8px;">ì‚­ì œ</button>
        </div>
    </div>
</div>
<div id="settingsModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px; height: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
            <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary);">âš™ï¸ í™˜ê²½ ì„¤ì •</h3>
            <button id="closeSettingsBtn" style="background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 24px;">&times;</button>
        </div>

        <div style="margin-bottom: 24px;">
            <h4 style="font-size: 16px; margin-bottom: 12px; color: var(--text-primary);">í™”ë©´ ëª¨ë“œ</h4>
            <div style="display: flex; gap: 10px; background: var(--bg-input); padding: 4px; border-radius: 8px;">
                <button id="darkModeBtn" class="theme-btn active" style="flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    ğŸŒ™ ë‹¤í¬ ëª¨ë“œ
                </button>
                <button id="lightModeBtn" class="theme-btn" style="flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ
                </button>
            </div>
        </div>

        <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
            * ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
        </p>
    </div>
</div>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const userStr = localStorage.getItem('user');
    const authButtons = document.getElementById('authButtons');
    const userMenu = document.getElementById('userMenu');
    const userNameSpan = document.getElementById('userName');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesList = document.getElementById('messagesList');
    const conversationsList = document.getElementById('conversationsList'); // ì‚¬ì´ë“œë°” ëª©ë¡
    const emptyState = document.getElementById('emptyState');

    let currentUser = null;
    let currentConversationId = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” ëŒ€í™”ë°© ID

    const toggleBtn = document.getElementById('toggleSidebarBtn'); // ì™¼ìª½ ìƒë‹¨ ì•„ì´ì½˜ ë²„íŠ¼
    const sidebar = document.getElementById('sidebar');            // ì‚¬ì´ë“œë°” ìš”ì†Œ

    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed'); // í´ë˜ìŠ¤ë¥¼ ì¤¬ë‹¤ ëºì—ˆë‹¤ í•¨
        });
    }

    // 0.5 ëª¨ë¸ ì„ íƒ ê¸°ëŠ¥
    const modelBtn = document.getElementById('modelBtn');
    const modelMenu = document.getElementById('modelMenu');
    const currentModelText = document.getElementById('currentModelText');
    let currentModel = 'gpt-4'; // ê¸°ë³¸ê°’

    // ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
    modelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        modelMenu.classList.toggle('hidden');
    });

    // ëª¨ë¸ ì„ íƒí•˜ê¸°
    document.querySelectorAll('.model-option').forEach(option => {
        option.addEventListener('click', () => {
            currentModel = option.dataset.value; // ì„ íƒí•œ ëª¨ë¸ ê°’ ì €ì¥
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ (ì„¤ëª… ë¹¼ê³  ì´ë¦„ë§Œ)
            currentModelText.textContent = option.querySelector('.model-name').textContent;
            
            modelMenu.classList.add('hidden'); // ë©”ë‰´ ë‹«ê¸°
        });
    });

    // í™”ë©´ ì•„ë¬´ë°ë‚˜ í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener('click', () => {
        if (!modelMenu.classList.contains('hidden')) {
            modelMenu.classList.add('hidden');
        }
    });

    // 1. ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    if (userStr) {
        currentUser = JSON.parse(userStr);
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        userNameSpan.textContent = currentUser.name;
        messageInput.disabled = false;
        
        // ë¡œê·¸ì¸í–ˆìœ¼ë©´ ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadConversations();
    } else {
        messageInput.disabled = true;
        messageInput.placeholder = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    }
    const accountBtn = document.getElementById('accountBtn');
    if (accountBtn) {
        accountBtn.addEventListener('click', () => {
            window.location.href = 'mypage.html';
        });
    }
    // 2. ë¡œê·¸ì•„ì›ƒ
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            localStorage.removeItem('user');
            window.location.reload();
        }
    });

    // 3. ìƒˆ ì±„íŒ… ë²„íŠ¼
    document.getElementById('newChatBtn').addEventListener('click', () => {
        currentConversationId = null;
        messagesList.innerHTML = ''; // í™”ë©´ ë¹„ìš°ê¸°
        emptyState.classList.remove('hidden');
        loadConversations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì„ íƒ íš¨ê³¼ ì œê±°ìš©)
    });

    // ==========================================
    // [ìˆ˜ì •ë¨] 4. ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° + ì»¤ìŠ¤í…€ ì‚­ì œ ëª¨ë‹¬
    // ==========================================
    
    // ì‚­ì œí•  ëŒ€í™”ë°© IDë¥¼ ì„ì‹œë¡œ ì €ì¥í•  ë³€ìˆ˜
    let pendingDeleteId = null;
    
    // ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const confirmModal = document.getElementById('confirmModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    // [ëª¨ë‹¬ ì´ë²¤íŠ¸] ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
    cancelDeleteBtn.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
        pendingDeleteId = null;
    });

    // [ëª¨ë‹¬ ì´ë²¤íŠ¸] ì‚­ì œ í™•ì • ë²„íŠ¼ í´ë¦­ ì‹œ
    confirmDeleteBtn.addEventListener('click', async () => {
        if (!pendingDeleteId) return;

        try {
            const res = await fetch(`/api/conversations/${pendingDeleteId}`, { method: 'DELETE' });
            if (res.ok) {
                // í˜„ì¬ ë³´ê³  ìˆëŠ” ë°©ì„ ì‚­ì œí–ˆë‹¤ë©´ í™”ë©´ ë¹„ìš°ê¸°
                if (currentConversationId === pendingDeleteId) {
                    document.getElementById('newChatBtn').click();
                }
                loadConversations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (err) {
            console.error(err);
        } finally {
            // ëª¨ë‹¬ ë‹«ê¸° ë° ì´ˆê¸°í™”
            confirmModal.classList.add('hidden');
            pendingDeleteId = null;
        }
    });

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            confirmModal.classList.add('hidden');
            pendingDeleteId = null;
        }
    });

    async function loadConversations() {
        if (!currentUser) return;
        const res = await fetch(`/api/conversations/${currentUser.id}`);
        const conversations = await res.json();
        
        conversationsList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        
        conversations.forEach(conv => {
            const div = document.createElement('div');
            div.className = 'conversation-item';
            
            // HTML êµ¬ì„±: ì œëª© + ì‚­ì œ ë²„íŠ¼(íœ´ì§€í†µ)
            div.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <div class="conversation-title">${conv.title}</div>
                <div class="conversation-actions">
                    <button class="conversation-action-btn delete-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `;

            // 1. ëª©ë¡ í´ë¦­ ì‹œ í•´ë‹¹ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
            div.addEventListener('click', () => loadMessages(conv.id));

            // 2. ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì»¤ìŠ¤í…€ ëª¨ë‹¬ í˜¸ì¶œ)
            const deleteBtn = div.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // ëª©ë¡ í´ë¦­ ë°©ì§€
                pendingDeleteId = conv.id; // ì‚­ì œí•  ID ì €ì¥
                confirmModal.classList.remove('hidden'); // ëª¨ë‹¬ ì—´ê¸°
            });

            conversationsList.appendChild(div);
        });
    }

    // 5. íŠ¹ì • ëŒ€í™” ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadMessages(conversationId) {
        currentConversationId = conversationId;
        emptyState.classList.add('hidden');
        messagesList.innerHTML = ''; // í™”ë©´ ì´ˆê¸°í™”

        const res = await fetch(`/api/conversations/${conversationId}/messages`);
        const messages = await res.json();

        messages.forEach(msg => appendMessage(msg.role, msg.content, msg.cost, msg.model));
        
        // ì‚¬ì´ë“œë°” ì„ íƒ íš¨ê³¼ (ê°„ë‹¨íˆ)
        loadConversations().then(() => {
            // ì—¬ê¸°ì— ì„ íƒëœ í•­ëª© í•˜ì´ë¼ì´íŠ¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        });
    }

    const fileInput = document.getElementById('fileInput');
    const attachBtn = document.getElementById('attachBtn');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageBtn = document.getElementById('removeImageBtn');

    let currentImageBase64 = null; // ì „ì†¡í•  ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥ìš©

    function checkSendButton() {
        const hasText = messageInput.value.trim().length > 0;
        const hasImage = currentImageBase64 !== null;
        
        // í…ìŠ¤íŠ¸ë‚˜ ì´ë¯¸ì§€ ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë²„íŠ¼ í™œì„±í™”
        sendBtn.disabled = !(hasText || hasImage);
    }

    // [ìœ„ì¹˜] function checkSendButton() { ... } ë°”ë¡œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

    // 1. [ì¶”ê°€ë¨] í…ìŠ¤íŠ¸ ì…ë ¥ ê°ì§€ (ë²„íŠ¼ í™œì„±í™” + ë†’ì´ ì¡°ì ˆ)
    messageInput.addEventListener('input', function() {
        checkSendButton(); // í…ìŠ¤íŠ¸ ì¹  ë•Œë§ˆë‹¤ ë²„íŠ¼ ìƒíƒœ í™•ì¸
        
        // ë†’ì´ ìë™ ì¡°ì ˆ ë¡œì§
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.scrollHeight > 200) {
            this.style.overflowY = "scroll";
        } else {
            this.style.overflowY = "hidden";
        }
    });

    // 2. [ìˆ˜ì •ë¨] íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬ (ë²„íŠ¼ í™œì„±í™” ì¶”ê°€)
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            currentImageBase64 = e.target.result;
            imagePreview.src = currentImageBase64;
            imagePreviewContainer.classList.remove('hidden');
            messageInput.focus();
            
            checkSendButton(); // [ì¤‘ìš”] ì‚¬ì§„ì´ ì˜¬ë¼ê°”ìœ¼ë‹ˆ ë²„íŠ¼ ì¼œê¸°!
        };
        reader.readAsDataURL(file);
    });

    // 3. [ìˆ˜ì •ë¨] ë¯¸ë¦¬ë³´ê¸° ì‚­ì œ ë²„íŠ¼ (ë²„íŠ¼ ìƒíƒœ ì¬í™•ì¸)
    removeImageBtn.addEventListener('click', () => {
        fileInput.value = '';
        currentImageBase64 = null;
        imagePreviewContainer.classList.add('hidden');
        
        checkSendButton(); // [ì¤‘ìš”] ì‚¬ì§„ ì§€ì› ìœ¼ë‹ˆ ë²„íŠ¼ ìƒíƒœ ë‹¤ì‹œ ì²´í¬
    });

    // 4. [í•„ìˆ˜] ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì—°ê²°
    sendBtn.addEventListener('click', sendMessage);

    // 5. [í•„ìˆ˜] ì—”í„°í‚¤ ì „ì†¡ ì—°ê²°
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) { 
                sendMessage();
            }
        }
    });

    // 1. í´ë¦½ ë²„íŠ¼ í´ë¦­ -> íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
    attachBtn.addEventListener('click', () => fileInput.click());

    // 2. íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬ (Base64 ë³€í™˜ ë° ë¯¸ë¦¬ë³´ê¸°)
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            currentImageBase64 = e.target.result; // Base64 ë¬¸ìì—´ ì €ì¥
            imagePreview.src = currentImageBase64;
            imagePreviewContainer.classList.remove('hidden'); // ë¯¸ë¦¬ë³´ê¸° ë³´ì—¬ì£¼ê¸°
            messageInput.focus();
        };
        reader.readAsDataURL(file); // íŒŒì¼ì„ ì½ì–´ì„œ ë¬¸ìì—´ë¡œ ë³€í™˜
    });

    // 3. ë¯¸ë¦¬ë³´ê¸° ì‚­ì œ ë²„íŠ¼
    removeImageBtn.addEventListener('click', () => {
        fileInput.value = '';
        currentImageBase64 = null;
        imagePreviewContainer.classList.add('hidden');
    });

    // 6. ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
        const text = messageInput.value.trim();
        
        // í…ìŠ¤íŠ¸ë„ ì—†ê³  ì´ë¯¸ì§€ë„ ì—†ìœ¼ë©´ ë¦¬í„´
        if ((!text && !currentImageBase64) || !currentUser) return;

        // í™”ë©´ ì´ˆê¸°í™”
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendBtn.disabled = true;
        emptyState.classList.add('hidden');
        
        // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™” (ì¤‘ìš”)
        imagePreviewContainer.classList.add('hidden');
        
        // ë‚´ ë©”ì‹œì§€ í‘œì‹œ (ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ë„ ê°™ì´ í‘œì‹œ)
        if (currentImageBase64) {
            appendMessage('user', `<img src="${currentImageBase64}" style="max-width: 200px; border-radius: 8px; display: block; margin-bottom: 8px;"> ${text}`);
        } else {
            appendMessage('user', text);
        }

        // ì „ì†¡í•  ë°ì´í„° ë°±ì—… (ì „ì†¡ í›„ ë³€ìˆ˜ ì´ˆê¸°í™” ìœ„í•´)
        const payloadImage = currentImageBase64;
        const payloadText = text;
        
        // ë³€ìˆ˜ ì´ˆê¸°í™”
        currentImageBase64 = null; 
        fileInput.value = '';
        const systemPrompt = localStorage.getItem('systemPrompt') || "";
        try {
            const loadingId = appendMessage('assistant', '...'); 
            
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    message: payloadText,
                    image: payloadImage, // [NEW] ì´ë¯¸ì§€ ë°ì´í„° ì¶”ê°€ ì „ì†¡
                    conversationId: currentConversationId,
                    model: currentModel,
                    systemInstruction: systemPrompt
                })
            });

            const data = await res.json();
            document.getElementById(loadingId).remove();

            if (res.ok) {
                appendMessage('assistant', data.reply, data.cost, currentModel);
                if (!currentConversationId) {
                    currentConversationId = data.conversationId;
                    loadConversations();
                }
            } else {
                appendMessage('assistant', 'Error: ' + data.error);
            }
        } catch (e) {
            console.error(e);
        }
    }

    // [ìˆ˜ì •ë¨] í™”ë©´ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ë‚´ í”„ë¡œí•„ ì‚¬ì§„ & ì´ë¦„ ì ìš©)
    function appendMessage(role, text, cost = null, modelName = null) {
        const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const isUser = role === 'user';
        let contentHtml = isUser ? text : marked.parse(text);

        // 1. ë¹„ìš© ë±ƒì§€ (AIì¸ ê²½ìš°ë§Œ)
        let costBadge = '';
        if (role === 'assistant' && cost !== null) {
            costBadge = `<div class="cost-badge"><span>ğŸ’¸ ${cost}ì›</span></div>`;
        }

        // 2. ì´ë¦„ ë° ì•„ë°”íƒ€ ì„¤ì •
        let displayName = '';
        let avatarHtml = '';

        if (isUser) {
            // [ìœ ì €ì¼ ë•Œ] ë‚´ ì´ë¦„ê³¼ ì‚¬ì§„ ì‚¬ìš©
            displayName = currentUser ? currentUser.name : 'ë‚˜';
            
            if (currentUser && currentUser.profile_image) {
                // í”„ë¡œí•„ ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì´ë¯¸ì§€ íƒœê·¸ ì‚¬ìš©
                avatarHtml = `<img src="${currentUser.profile_image}" class="message-avatar" style="object-fit: cover; border: 1px solid rgba(255,255,255,0.1);">`;
            } else {
                // ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒë€ìƒ‰ ì•„ì´ì½˜ ì‚¬ìš©
                avatarHtml = `
                    <div class="message-avatar user">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>`;
            }
        } else {
            // [AIì¼ ë•Œ] ëª¨ë¸ ì´ë¦„ê³¼ ë¡œë´‡ ì•„ì´ì½˜ ì‚¬ìš©
            displayName = modelName ? modelName.toUpperCase() : 'ChatCheappt';
            avatarHtml = `
                <div class="message-avatar assistant">
                    <div class="logo-icon" style="font-size: 16px;">ğŸ¤–</div>
                </div>`;
        }

        const html = `
            <div class="message" id="${msgId}">
                ${avatarHtml}
                <div class="message-content">
                    <div class="message-role">${displayName}</div>
                    <div class="message-text markdown-body">${contentHtml}</div>
                    ${costBadge}
                </div>
            </div>
        `;
        
        messagesList.insertAdjacentHTML('beforeend', html);
        
        const newMessage = document.getElementById(msgId);
        newMessage.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });

        messagesList.scrollTop = messagesList.scrollHeight;
        return msgId;
    }
    // [NEW] ê°¤ëŸ¬ë¦¬ ê¸°ëŠ¥ êµ¬í˜„ (ì‚­ì œ ê¸°ëŠ¥ í¬í•¨ ì™„ë£Œ)
    const galleryBtn = document.getElementById('galleryBtn');
    const galleryModal = document.getElementById('galleryModal');
    const closeGalleryBtn = document.getElementById('closeGalleryBtn');
    const galleryGrid = document.getElementById('galleryGrid');

    // ì´ë¯¸ì§€ ì‚­ì œ ê´€ë ¨ ìš”ì†Œ
    const imageDeleteModal = document.getElementById('imageDeleteModal');
    const confirmImgDeleteBtn = document.getElementById('confirmImgDeleteBtn');
    const cancelImgDeleteBtn = document.getElementById('cancelImgDeleteBtn');
    let pendingImageId = null; // ì‚­ì œ ëŒ€ê¸° ì¤‘ì¸ ì´ë¯¸ì§€ ID

    // 1. ê°¤ëŸ¬ë¦¬ ì—´ê¸° (ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ)
    galleryBtn.addEventListener('click', async () => {
        if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        
        galleryModal.classList.remove('hidden');
        galleryGrid.innerHTML = '<p style="text-align:center; color:#888; grid-column: 1/-1; padding: 20px;">ë¡œë”© ì¤‘...</p>';

        try {
            const res = await fetch(`/api/images/${currentUser.id}`);
            const images = await res.json();

            galleryGrid.innerHTML = '';

            if (images.length === 0) {
                galleryGrid.innerHTML = '<p style="text-align:center; color:#888; grid-column: 1/-1; padding: 20px;">ì €ì¥ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                // HTML: ì´ë¯¸ì§€ + ì˜¤ë²„ë ˆì´ + ì‚­ì œë²„íŠ¼(íœ´ì§€í†µ ì•„ì´ì½˜)
                div.innerHTML = `
                    <img src="${img.image_path}" alt="${img.prompt}" loading="lazy">
                    
                    <button class="gallery-delete-btn" onclick="openImageDeleteModal(${img.id})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>

                    <div class="gallery-overlay">
                        <p class="gallery-prompt">${img.prompt}</p>
                        <div style="margin-top: 4px;">
                            <a href="${img.image_path}" download class="gallery-link">ë‹¤ìš´ë¡œë“œ</a>
                        </div>
                    </div>
                `;
                galleryGrid.appendChild(div);
            });
        } catch (err) {
            console.error(err);
            galleryGrid.innerHTML = '<p>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
        }
    });

    // 2. ì‚­ì œ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (HTML onclickì—ì„œ í˜¸ì¶œ)
    window.openImageDeleteModal = (id) => {
        pendingImageId = id;
        imageDeleteModal.classList.remove('hidden');
    };

    // 3. ì‚­ì œ í™•ì • ë²„íŠ¼ í´ë¦­
    confirmImgDeleteBtn.addEventListener('click', async () => {
        if (!pendingImageId) return;

        try {
            const res = await fetch(`/api/images/${pendingImageId}`, { method: 'DELETE' });
            const result = await res.json();

            if (result.success) {
                // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê³  ê°¤ëŸ¬ë¦¬ ìƒˆë¡œê³ ì¹¨
                imageDeleteModal.classList.add('hidden');
                galleryBtn.click(); // ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ê°„í¸í•œ ë°©ë²•)
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (e) {
            console.error(e);
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    });

    // 4. ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ ë²„íŠ¼)
    cancelImgDeleteBtn.addEventListener('click', () => {
        imageDeleteModal.classList.add('hidden');
        pendingImageId = null;
    });

    // 5. ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ë‹«ê¸° (ê°¤ëŸ¬ë¦¬ & ì‚­ì œëª¨ë‹¬ ë‘˜ ë‹¤)
    window.addEventListener('click', (e) => {
        if (e.target === galleryModal) galleryModal.classList.add('hidden');
        if (e.target === imageDeleteModal) imageDeleteModal.classList.add('hidden');
    });

    closeGalleryBtn.addEventListener('click', () => galleryModal.classList.add('hidden'));

    // ==========================================
    // [NEW] ì„¤ì • ëª¨ë‹¬ & í…Œë§ˆ ë³€ê²½ ê¸°ëŠ¥
    // ==========================================
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const darkModeBtn = document.getElementById('darkModeBtn');
    const lightModeBtn = document.getElementById('lightModeBtn');

    // 1. ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
        });
    }

    // 2. ì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
    if (closeSettingsBtn) {
        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
    }

    // 3. í…Œë§ˆ ë³€ê²½ í•¨ìˆ˜
    function applyTheme(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-mode');
            lightModeBtn.classList.add('active');
            darkModeBtn.classList.remove('active');
        } else {
            document.body.classList.remove('light-mode');
            darkModeBtn.classList.add('active');
            lightModeBtn.classList.remove('active');
        }
        localStorage.setItem('theme', theme); // ì €ì¥
    }

    // 4. ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    darkModeBtn.addEventListener('click', () => applyTheme('dark'));
    lightModeBtn.addEventListener('click', () => applyTheme('light'));

    // 5. ì´ˆê¸° ì‹¤í–‰ ì‹œ ì €ì¥ëœ í…Œë§ˆ ë¶ˆëŸ¬ì˜¤ê¸°
    const savedTheme = localStorage.getItem('theme') || 'dark';
    applyTheme(savedTheme);

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ì„¤ì • ëª¨ë‹¬ìš© ì¶”ê°€)
    window.addEventListener('click', (e) => {
        if (e.target === settingsModal) settingsModal.classList.add('hidden');
    });
});
</script>
</html>